{% extends "layouts.master" %}

{% block title %}{{ file.project.name }} - {{ file.name }} - {{ lang.name }}{% endblock %}

{% block scripts %}
<script type="text/javascript">
$(document).ready(function() {
    $('tr').click(function trclick() {
        var translationCell = $(this).find('td#translation');
        var id = $(this).attr('id');
        var lang = $(this).parents('table').attr('id');
        var form = '<div class="container-fluid"><div class="row"><textarea>' + translationCell.html() + '</textarea></div><div class="row"><div class="col-md-4"><input class="btn btn-primary" id="save" type="button" value="Save"></div><div class="col-md-4"><input class="btn" id="cancel" type="button" value="Cancel"></div><div class="col-md-4"><div class="checkbox"><label><input type="checkbox" id="needswork" value="1"> Needs work</label></div></div></div></div>';
        translationCell.html(form);
        translationCell.removeClass('needs-work');
        $(this).unbind('click');
        var sendButton = $(translationCell).find('input#save');
        var cancelButton = $(translationCell).find('input#cancel');
        var needsWorkCheckbox = $(translationCell).find('input#needswork');
        var textarea = $(translationCell).find('textarea');
        var tr = $(this);
        textarea.prop('disabled', true);
        $.ajax({
            type: 'GET',
            dataType: 'json',
            url: '{{ url('/') }}/texts/' + id + '/lang/' + lang,
            success: function (data) {
                textarea.val(data.translation);
                needsWorkCheckbox.prop('checked', data.needswork);
                textarea.prop('disabled', false);
                textarea.focus();
                textarea.select();
            }
        });
        sendButton.click(function() {
            textarea.prop('disabled', true);
            $.ajax({
                type: 'POST',
                data: { '_token': '{{ csrf_token() }}', 'translation': textarea.val(), 'needswork': needsWorkCheckbox.prop('checked') },
                url: '{{ url('/') }}/texts/' + id + '/lang/' + lang,
                success: function (data) {
                    if(data.needswork)
                        translationCell.addClass('needs-work');
                    else
                        translationCell.removeClass('needs-work');
                    translationCell.html(data.translation);
                    tr.click(trclick);
                    tr.next().click();
                }
            });
        });
        cancelButton.click(function() {
            $.ajax({
                type: 'GET',
                dataType: 'json',
                url: '{{ url('/') }}/texts/' + id + '/lang/' + lang,
                success: function (data) {
                    if(data.needswork)
                        translationCell.addClass('needs-work');
                    else
                        translationCell.removeClass('needs-work');
                    translationCell.html(data.translation);
                    tr.click(trclick);
                }
            });
        });
    });
    $('#upload-form').submit(function(e) {
        if(confirm("This will overwrite all translations. Are you sure?")) {
            return true;
        }
        else {
            e.preventDefault();
            return false;
        }
    });
});
</script>
{% endblock %}

{% block content %}
<ol class="breadcrumb">
    <li>{{ link_to_route('projects.index', 'Home') }}</li>
    <li>{{ link_to_route('projects.show', file.project.name, {project: file.project}) }}</li>
    <li>{{ link_to_route('projects.show', file.name, {project: file.project}) }}</li>
    <li class="active">{{ lang.name }}</li>
</ol>
<h2>Upload {{ lang.iso_code }}.catkeys</h2>
{{ form_open({url: route('files.import', {file: file.id, lang: lang.id}), method: POST, files: true, 'id': 'upload-form'}) }}
{{ form_file('catkeys', null) }}
{{ form_submit('Upload new') }}
{{ form_close() }}
<h2>Translations to {{ lang.name }}</h2>
{% for context, textsGrouped in texts.groupBy('context') %}
<h3>{{ context }}</h3>
<table class="table" id="{{ lang.id }}">
    {% for text in textsGrouped %}
    <tr id="{{ text.id }}">
        <td><p>{{ text.text }}</p><p><small>{{ text.comment }}</small></p></td>
        {% set translation = translations[text.id][0] %}
        {% if translation == null %}
            <td id="translation" class="needs-work">{{ text.text }}</td>
        {% else %}
            {% set needswork = translation.needs_work == true %}
            <td id="translation"{% if needswork %} class="needs-work"{% endif %}>{{ translations[text.id][0].translation }}</td>
        {% endif %}
    </tr>
    {% endfor %}
</table>
{% endfor %}
{{ texts.links() | raw }}

{% endblock %}
